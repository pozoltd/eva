{% extends 'layout.twig' %}

{% set folderId = app.request.get('folder') ?: 0 %}

{% block extraHead %}
    <link href="{{ constant('CDN') }}/inspinia/css/plugins/jsTree/style.min.css" rel="stylesheet">
    <style>
        .file-box {
            background: #f3f3f4;
            border: 1px solid #f3f3f4;
            margin: .5em;
        }
        .file {
            margin: 0;
        }
    </style>
{% endblock %}



{% block extraHeaderLeft %}
    <h2>File Manager</h2>

{% endblock %}


{% block content %}
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-lg-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <div class="file-manager">
                            <div class="input-group">
                                <input type="text" class="form-control" style="padding: 0 .5em !important;height: 34px;">
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-default">Go</button>
                                </span>
                            </div>

                            <div class="hr-line-dashed"></div>
                            <input id="fileupload" type="file" name="files[]" multiple style="display: none;">
                            <div class="progress progress-striped" style="display: none; width: 350px;">
                                <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                            </div>
                            <button class="btn btn-primary btn-block" onclick="$('#fileupload').click();">Upload Files</button>
                            <div class="hr-line-dashed"></div>
                            <h5>Folders</h5>
                            <div id="jstree1">
                                <ul>
                                    <li class="jstree-open">Home
                                        <ul>
                                            <li data-tgt="tgt1">css</li>
                                            <li data-tgt="tgt2">email-templates</li>
                                            <li data-tgt="tgt3" class="jstree-open highlight">fonts
                                                <ul>
                                                    <li data-tgt="tgt4">glyphicons-halflings-regular.eot</li>
                                                    <li data-tgt="tgt5">glyphicons-halflings-regular.svg</li>
                                                    <li data-tgt="tgt6">glyphicons-halflings-regular.ttf</li>
                                                    <li data-tgt="tgt7">glyphicons-halflings-regular.woff</li>
                                                </ul>
                                            </li>

                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 animated fadeInRight">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <div style="float: left">
                                    <ol class="breadcrumb" style="display: inline-block">
                                        <li>
                                            <a href="index.html">Home</a>
                                        </li>
                                        <li>
                                            Css
                                        </li>
                                        <li class="active">
                                            <strong>fdas</strong>
                                        </li>
                                    </ol>
                                </div>

                                <div class="ibox-tools" d>
                                    <button class="btn btn-xs btn-circle btn-warning">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="btn btn-xs btn-circle btn-primary">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                    <button class="btn btn-xs btn-circle btn-danger">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12" id="nestable2"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block extraFooter %}
    <script src="{{ constant('CDN') }}/inspinia/js/plugins/jsTree/jstree.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.5.7/jquery.iframe-transport.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.5.7/jquery.fileupload.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.0.4/jquery.imagesloaded.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.14.0/jquery.validate.min.js"></script>


    <script id="file-list-item" type="text/x-handlebars-template">{% include 'handlebars/file-list-item.twig' %}</script>
    <script>
        var _fileListItem = $("#file-list-item").html();
        var _files = [];
        var _folders = {};

        $(function () {
            $('#fileupload').fileupload({
                url: '{{ path('upload-assets') }}',
                dataType: 'json',
                sequentialUploads: true,
                formData: {
                    parentId: '{{ folderId }}',
                },
                add: function(e, data) {
                    var uploadErrors = [];
                    if(data.files[0]['size'] == '' || data.files[0]['size'] > 50000000) {
                        uploadErrors.push('File size is too big');
                    }
                    if(uploadErrors.length > 0) {
                        alert(uploadErrors.join("\n"));
                    } else {
                        $('.progress').show();
                        data.submit();
                    }
                },
                start: function () {
                    $('.progress-bar').css('width', 0);
                },
                done: function (e, data) {
//                    _files.push(data.result);
//                    repaint();
                },
                progressall: function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('.progress-bar').css('width', progress + '%');
                },
                stop: function (e) {
                    $('.progress').fadeOut(3000);
                }
            }).prop('disabled', !$.support.fileInput).parent().addClass($.support.fileInput ? undefined : 'disabled');


            $('#nestable2').sortable({
                cursorAt: {left: -30, top: -30}
            });

            $('#jstree1').jstree({
                'core': {
                    'check_callback': true
                },
                'plugins': ['types', 'dnd'],
                'types': {
                    'default': {
                        'icon': 'fa fa-folder'
                    },

                }
            });

            window._src = null;
            $('body').mousedown(function(ev) {
                window._src = $(ev.target).data('src');
                if (!window._src) {
                    window._src = $(ev.target).closest('.file-box').data('src');
                }

                    console.log(window._src)
            })

            $('body').mouseup(function(ev) {
                var tgt = $(ev.target).closest('li').data('tgt')
//            console.log(window._src, tgt)
//                if (window._src && tgt) {
//                    for (var idx in files) {
//                        var itm = files[idx];
//                        if (itm.id == window._src) {
//                            files.splice(idx, 1)
//                        }
//                    }
////                console.log(files)
////                    renderFiles();
//                }
                window._src = null;
//            console.log()
            })

            $.ajax({
                type: 'POST',
                url: '{{ path('fetch-folders') }}',
                success: function (data) {
                    _folders = data;
                    console.log(_folders)
                }
            });

            $.ajax({
                type: 'POST',
                url: '{{ path('fetch-files') }}',
                data: 'folder={{ folderId }}',
                success: function (data) {
                    _files = data;
                    renderFiles();
                }
            });

        });

        function renderFiles() {
            var template = Handlebars.compile(_fileListItem);

            $('#nestable2').empty();
            for (var idx in _files) {
                var itm = _files[idx];
                $('#nestable2').append(template(itm))
            }
        }
    </script>


{% endblock %}

